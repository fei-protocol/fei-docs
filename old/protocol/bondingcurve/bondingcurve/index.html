<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>BondingCurve - Fei Protocol Docs</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">Fei Protocol Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../../.." class="nav-link">Overview</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../../user/user/" class="nav-link">User</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../../developers/developers/" class="nav-link">Developer</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../../operator/operator/" class="nav-link">Operator</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/fei-protocol/fei-docs/edit/main/docs/old/protocol/bondingcurve/bondingcurve.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#bondingcurve" class="nav-link">BondingCurve</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#contract" class="nav-link">Contract</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#description" class="nav-link">Description</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#access-control" class="nav-link">Access Control</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#events" class="nav-link">Events</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#read-only-functions" class="nav-link">Read-Only Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#public-state-changing-functions" class="nav-link">Public State-Changing Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#eoa-only-state-changing-functions" class="nav-link">EOA-Only üë§ State-Changing Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#governor-only-state-changing-functions" class="nav-link">Governor-Only‚öñÔ∏è State-Changing Functions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#abis" class="nav-link">ABIs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="bondingcurve">BondingCurve</h1>
<h2 id="contract">Contract</h2>
<p><a href="https://github.com/fei-protocol/fei-protocol-core/blob/master/contracts/bondingcurve/BondingCurve.sol">BondingCurve.sol</a> implements <a href="https://github.com/fei-protocol/fei-protocol-core/blob/master/contracts/bondingcurve/IBondingCurve.sol">IBondingCurve</a>, <a href="https://github.com/fei-protocol/fei-protocol-core/blob/master/contracts/refs/OracleRef.sol">OracleRef</a>, <a href="https://github.com/fei-protocol/fei-protocol-core/blob/master/contracts/pcv/PCVSplitter.sol">PCVSplitter</a></p>
<h2 id="description">Description</h2>
<p>An abstract bonding curve for purchasing FEI and routing of the purchased asset to PCV.</p>
<p>The amount of PCV it takes in a purchase transaction to bring the curve to a total amount of FEI issued <em>T</em> is determined by integrating the price function between the current FEI amount issued <em>C</em> by the bonding curve and the target amount <em>T</em> after the transaction. </p>
<p><img alt="Amount of PCV out for a purchase" src="../../.gitbook/assets/screen-shot-2021-02-14-at-3.04.23-pm.png" /></p>
<p>The quantity <em>T-C</em> is the amount of FEI received by the transaction. Since <em>C</em> is a known constant, we solve for <em>T</em> by setting the formula equal to a PCV purchase quantity <em>Q</em> and rearranging terms.</p>
<p>Post scale, the price should be $1 + <em>b</em>  times the peg, where <em>b</em> is the variance buffer and the peg is reported as X per FEI. In the implementation, we use $1 - <em>b</em> because the peg is inverted so the price relationship is also inverted.</p>
<h3 id="allocation">Allocation</h3>
<p>Incoming PCV is held temporarily to allow for batch transactions via the <code>allocate()</code> function. The PCV allocation gets split into a weighted list of PCV deposit contracts, (see <a href="https://github.com/fei-protocol/fei-protocol-core/blob/master/contracts/pcv/PCVSplitter.sol">PCVSplitter</a>). While allocations can be called at any time, there is a 500 FEI incentive for calling it after each 24 hour window. To determine eligibility for the incentive, simply call <code>isTimeEnded()</code> on the contract. The time until the next incentive is available is <code>remainingTime()</code>.</p>
<p>{% page-ref page="../references/timed.md" %}</p>
<h2 id="access-control"><a href="../access-control/">Access Control</a></h2>
<ul>
<li>Minterüí∞</li>
</ul>
<h2 id="events">Events</h2>
<p>{% tabs %}
{% tab title="Purchase" %}
Purchase of FEI on bonding curve</p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">param</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">address indexed</td>
<td align="left">_to</td>
<td align="left">recipient of FEI</td>
</tr>
<tr>
<td align="left">uint256</td>
<td align="left">_amountIn</td>
<td align="left">amount of purchase asset</td>
</tr>
<tr>
<td align="left">uint256</td>
<td align="left">_amountOut</td>
<td align="left">amount of FEI</td>
</tr>
<tr>
<td align="left">{% endtab %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>{% tab title="Allocate" %}
Allocate held PCV</p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">param</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">address indexed</td>
<td align="left">_caller</td>
<td align="left">the sender of the allocation transaction</td>
</tr>
<tr>
<td align="left">uint256</td>
<td align="left">_amount</td>
<td align="left">the amount of PCV allocated</td>
</tr>
<tr>
<td align="left">{% endtab %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>{% tab title="ScaleUpdate" %}
Governance change of Scale target</p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">param</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">uint256</td>
<td align="left">_scale</td>
<td align="left">new Scale target</td>
</tr>
<tr>
<td align="left">{% endtab %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>{% tab title="BufferUpdate" %}
Governance change of Buffer</p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">param</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">uint256</td>
<td align="left">_buffer</td>
<td align="left">new buffer</td>
</tr>
<tr>
<td align="left">{% endtab %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>{% tab title="IncentiveAmountUpdate" %}
Changes the FEI reward for calling <code>allocate()</code></p>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">param</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">uint256</td>
<td align="left">_incentiveAmount</td>
<td align="left">new incentive amount</td>
</tr>
<tr>
<td align="left">{% endtab %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">{% endtabs %}</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h2 id="read-only-functions">Read-Only Functions</h2>
<h3 id="getcurrentprice">getCurrentPrice</h3>
<pre><code class="language-javascript">function getCurrentPrice() external view returns (Decimal.D256 memory);
</code></pre>
<p>Returns current instantaneous bonding curve price. The price reported as FEI per X, with X being the underlying asset. This is analogous to the peg reported by the oracle.</p>
<p>{% page-ref page="../oracles/" %}</p>
<p>{% hint style="warning" %}
Can be inaccurate if outdated, need to call <code>oracle().isOutdated()</code> to check
{% endhint %}</p>
<h3 id="getaverageusdprice">getAverageUSDPrice</h3>
<pre><code class="language-javascript">function getAverageUSDPrice(uint256 amountIn)
    external
    view
    returns (Decimal.D256 memory);
</code></pre>
<p>Returns the average price of a transaction of size <code>amountIn</code> ETH along bonding curve. The price here is reported as USD per FEI.</p>
<p>{% hint style="warning" %}
Can be inaccurate if outdated, need to call <code>oracle().isOutdated()</code> to check
{% endhint %}</p>
<h3 id="getamountout">getAmountOut</h3>
<pre><code class="language-javascript">function getAmountOut(uint256 amountIn)
    external
    view
    returns (uint256 amountOut);
</code></pre>
<p>Returns the amount <code>amountOut</code>of FEI received for a purchase of <code>amountIn</code> ETH.</p>
<p>{% hint style="warning" %}
Can be inaccurate if outdated, need to call <code>oracle().isOutdated()</code> to check
{% endhint %}</p>
<h3 id="scale">scale</h3>
<pre><code class="language-javascript">function scale() external view returns (uint256);
</code></pre>
<p>The target <code>totalPurchased</code> after which the bonding curve price switches to a fixed premium on the peg.</p>
<h3 id="atscale">atScale</h3>
<pre><code class="language-javascript">function atScale() external view returns (bool);
</code></pre>
<p>Returns true when <code>totalPurchased()</code> is greater than <code>scale()</code></p>
<h3 id="buffer">buffer</h3>
<pre><code class="language-javascript">function buffer() external view returns (uint256);
</code></pre>
<p>The multiplier applied to the peg price when post-Scale.</p>
<h3 id="buffer_granularity">BUFFER_GRANULARITY</h3>
<pre><code class="language-javascript">function BUFFER_GRANULARITY() external view returns (uint256);
</code></pre>
<p>The granularity of the buffer. Constant at 10,000.</p>
<h3 id="totalpurchased">totalPurchased</h3>
<pre><code class="language-javascript">function totalPurchased() external view returns (uint256);
</code></pre>
<p>Returns the cumulative amount of FEI issued via the bonding curve. Used in the bonding curve formula as the supply amount.</p>
<h3 id="gettotalpcvheld">getTotalPCVHeld</h3>
<pre><code class="language-javascript">function getTotalPCVHeld() external view returns (uint256);
</code></pre>
<p>Returns the amount of PCV held in the contract and ready for allocation.</p>
<h3 id="incentiveamount">incentiveAmount</h3>
<pre><code class="language-javascript">function incentiveAmount() external view returns (uint256);
</code></pre>
<p>Returns the amount of FEI sent to the keeper who calls <code>allocate()</code> while the incentive is active.</p>
<h2 id="public-state-changing-functions">Public State-Changing Functions</h2>
<h3 id="purchase">purchase</h3>
<pre><code class="language-javascript">function purchase(address to, uint256 amountIn)
    external
    payable
    returns (uint256 amountOut);
</code></pre>
<p>Purchase <code>amountOut</code> FEI along the bonding curve for <code>amountIn</code> ETH and send the FEI to address <code>to</code>.</p>
<p>emits <code>Purchase</code></p>
<p>{% hint style="info" %}
This method is <a href="../../../governance/fei-guardian/">pausable</a>
{% endhint %}</p>
<h2 id="eoa-only-state-changing-functions">EOA-Only üë§ State-Changing Functions</h2>
<h3 id="allocate">allocate</h3>
<pre><code class="language-javascript">function allocate() external;
</code></pre>
<p>Allocate the PCV held by the bonding curve to the weighted PCV allocations returned by <code>getAllocation()</code>.</p>
<p>emits <code>Allocate</code></p>
<p>{% hint style="info" %}
This method is <a href="../../../governance/fei-guardian/">pausable</a>
{% endhint %}</p>
<h2 id="governor-only-state-changing-functions">Governor-Only<strong>‚öñÔ∏è</strong> State-Changing Functions</h2>
<h3 id="setbuffer"><strong>setBuffer</strong></h3>
<pre><code class="language-javascript">function setBuffer(uint256 _buffer) external;
</code></pre>
<p>Sets the buffer to <code>_buffer</code>. Must be less than <code>BUFFER_GRANULARITY</code></p>
<p>emits <code>BufferUpdate</code></p>
<h3 id="setscale"><strong>setScale</strong></h3>
<pre><code class="language-javascript">function setScale(uint256 _scale) external;
</code></pre>
<p>Sets the Scale target to <code>_scale</code></p>
<p>emits <code>ScaleUpdate</code></p>
<h3 id="setincentiveamount">setIncentiveAmount</h3>
<pre><code class="language-javascript">function setIncentiveAmount(uint256 _incentiveAmount) external;
</code></pre>
<p>Sets the <code>incentiveAmount</code> to <code>_incentiveAmount</code></p>
<p>emits <code>IncentiveAmountUpdate</code></p>
<h3 id="setincentivefrequency"><strong>setIncentiveFrequency</strong></h3>
<pre><code class="language-javascript">function setIncentiveFrequency(uint256 _frequency) external;
</code></pre>
<p>Sets the <a href="../../references/timed/">Timed</a> duration to <code>_frequency</code></p>
<p>emits <code>DurationUpdate</code></p>
<h3 id="setallocation"><strong>setAllocation</strong></h3>
<pre><code class="language-javascript">function setAllocation(
    address[] calldata pcvDeposits,
    uint256[] calldata ratios
) external;
</code></pre>
<p>Sets the PCV allocation to <code>pcvDeposits</code> with weights <code>ratios</code>. The ratios must sum to <code>ALLOCATION_GRANULARITY</code> which is constant at 10,000.</p>
<h2 id="abis">ABIs</h2>
<p>{% file src="../../.gitbook/assets/bondingcurve.json" caption="BondingCurve ABI" %}</p>
<p>{% file src="../../.gitbook/assets/ibondingcurve.json" caption="BondingCurve Interface ABI" %}</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js" defer></script>
        <script src="../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
